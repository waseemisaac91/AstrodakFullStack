// Translations object
const translations = {
  nl: {
    // Navigation
    "nav.home": "Home",
    "nav.about": "Over Ons",
    "nav.services": "Diensten",
    "nav.projects": "Projecten",
    "nav.contact": "Contact",
    "nav.quote": "Offerte Aanvragen",

    // Hero Section
    "hero.title": "Complete Dak Oplossingen",
    "hero.subtitle":
      "Expert in Dakisolatie, Zinkwerk, Hellende en Platte Daken",
    "hero.contact": "Neem Contact Op",
    "hero.services": "Ontdek Onze Diensten",

    // Services Section
    "services.title": "Onze Diensten",
    "services.flat.title": "Dakisolatie platte daken",
    "services.flat.description": "Bitumen - lichtkoepel",
    "services.zinc.title": "Zinkwerk",
    "services.zinc.description": "Dakgoten - Dakgootreiniging - kilgoot",
    "services.sloped.title": "Hellende Daken",
    "services.sloped.description":
      "Dakpannen - Dakisolatie - Dakraam - Nokvorst - Plastisol - Trespa - Boeiboord",
    "services.chimney.title": "Schoorsteen Reparatie",
    "services.chimney.description":
      "Lood Vervangen - Voegen - Coating - Impregneren",

    // About Section
    "about.title": "Over Ons",
    "about.paragraph1":
      "AstroDak Service is gespecialiseerd in dakisolatie en zinkwerk voor zowel hellende als platte daken Ons bedrijf werd opgericht met de visie om complete en hoogwaardige oplossingen aan onze klanten te bieden.",
    "about.paragraph2":
      "Wij beschikken over een professioneel team met ruime ervaring in dakbedekking en isolatie. Door gebruik te maken van de nieuwste technieken en kwalitatieve materialen, garanderen wij de tevredenheid van onze klanten.",
    "about.paragraph3":
      "Bij elk project streven wij naar de hoogste kwaliteits- en veiligheidsnormen, steeds met respect voor de afgesproken deadlines.",

    // Projects Section
    "projects.title": "Onze Projecten",
    "projects.filter.all": "Alle Projecten",
    "projects.filter.flat": "Dakisolatie Platte Daken",
    "projects.filter.zinc": "Zinkwerk",
    "projects.filter.sloped": "Hellende Daken",
    "projects.filter.chimney": "Schoorsteen Reparatie",

    // Process Section
    "process.title": "Hoe gaan Wij Te Werk",
    "process.step1.title": "Adviesgesprek",
    "process.step1.description":
      "Onze deskundige dakdekkers komen bij u thuis om de situatie te bekijken en uw wensen te bespreken.",
    "process.step2.title": "Offerte",
    "process.step2.description":
      "U ontvangt een vrijblijvende offerte op maat met een duidelijke prijsopgave.",
    "process.step3.title": "Uitvoering",
    "process.step3.description":
      "Na akkoord gaan we direct aan de slag met minimale overlast voor u en uw omgeving.",
    "process.step4.title": "Afronding",
    "process.step4.description":
      "We ruimen alles netjes op en controleren samen of het resultaat aan uw verwachtingen voldoet.",

    // Why Us Section
    "whyus.title": "Waarom AstroDak Service?",
    "whyus.subtitle":
      "Op zoek naar een betrouwbaar dakbedrijf? Kies voor AstroDak Service!",
    "whyus.intro":
      "Met jaren ervaring in Nederland én het buitenland zorgen wij voor:",
    "whyus.point1": "Professioneel en schoon werk",
    "whyus.point2": "Werken met eerlijkheid en betrouwbaarheid",
    "whyus.point3": "Volledige veiligheid – wij zijn VCA-gecertificeerd",
    "whyus.point4": "Snelle service zonder in te leveren op kwaliteit",
    "whyus.point5": "Concurrerende prijzen, realistisch en betaalbaar",
    "whyus.point6": "Tot 10 jaar garantie op ons werk!",
    "whyus.conclusion":
      "AstroDak Service – voor een dak waar u op kunt rekenen.",
    "whyus.cta": "Gratis Offerte Aanvragen",

    // Reviews Section
    "reviews.title": "Wat Onze Klanten Zeggen",
    "reviews.subtitle":
      "Lees ervaringen van tevreden klanten die onze diensten hebben gebruikt",
    // Add to the nl translations object
    "reviews.form.title": "Laat uw review achter",
    "reviews.form.name": "Naam",
    "reviews.form.review": "Review",
    "reviews.form.rating": "Beoordeling",
    "reviews.form.submit": "Review Versturen",

    // Contact Section
    "contact.title": "Contacteer Ons",
    "contact.info.title": "Contactgegevens",
    "contact.info.address": "Adres: Salahutunplein in Vught , Nederland",
    "contact.info.phone": "Telefoon:",
    "contact.info.email": "Email:",
    "contact.info.hours": "Openingstijden: Maandag t/m Vrijdag, 8:00 - 17:00",
    "contact.form.title": "Stuur Ons een Bericht",
    "contact.form.name": "Volledige Naam",
    "contact.form.email": "E-mail Adres",
    "contact.form.phone": "Telefoonnummer",
    "contact.form.subject": "Onderwerp",
    "contact.form.message": "Bericht",
    "contact.form.submit": "Verstuur Bericht",

    // Footer
    "footer.description":
      "Gespecialiseerd in dakisolatie, zinkwerk, hellende en platte daken. Wij bieden hoogwaardige oplossingen voor al uw dakbehoeften.",
    "footer.area.title": "Onze Werkgebied",
    "footer.links.title": "Snelle Links",
    "footer.contact.title": "Contactgegevens",
    "footer.contact.address": "Salahutunplein, Vught, Nederland",
    "footer.contact.hours": "Ma-Vrij: 8:00 - 17:00",
    "footer.copyright": "Alle rechten voorbehouden.",

    // WhatsApp
    "whatsapp.tooltip": "Stuur ons een bericht",
  },

  en: {
    // Navigation
    "nav.home": "Home",
    "nav.about": "About Us",
    "nav.services": "Services",
    "nav.projects": "Projects",
    "nav.contact": "Contact",
    "nav.quote": "Request Quote",

    // Hero Section
    "hero.title": "Complete Roofing Solutions",
    "hero.subtitle":
      "Expert in roof insulation, zinc work, sloped and flat roofs",
    "hero.contact": "Contact Us",
    "hero.services": "Discover Our Services",

    // Services Section
    "services.title": "Our Services",
    "services.flat.title": "Flat Roof Insulation",
    "services.flat.description": "Bitumen - skylights",
    "services.zinc.title": "Zinc Work",
    "services.zinc.description": "Gutters - Gutter Cleaning - valley gutters",
    "services.sloped.title": "Sloped Roofs",
    "services.sloped.description":
      "Roof tiles - Roof Insulation - Roof Windows - Ridge frost - Plastisol - Trespa - Fascia boards",
    "services.chimney.title": "Chimney Repair",
    "services.chimney.description":
      "Lead Replacement - Pointing - Coating - Impregnation",

    // About Section
    "about.title": "About Us",
    "about.paragraph1":
      "AstroDak Service specializes in roof insulation and zinc work for both pitched and flat roofs. Our company was founded with the vision to offer complete and high-quality solutions to our customers.",
    "about.paragraph2":
      "We have a professional team with extensive experience in roofing and insulation. By using the latest techniques and quality materials, we guarantee the satisfaction of our customers.",
    "about.paragraph3":
      "With every project we strive for the highest quality and safety standards, always respecting the agreed deadlines.",

    // Projects Section
    "projects.title": "Our Projects",
    "projects.filter.all": "All Projects",
    "projects.filter.flat": "Flat Roof Insulation",
    "projects.filter.zinc": "Zinc Work",
    "projects.filter.sloped": "Sloped Roofs",
    "projects.filter.chimney": "Chimney Repair",

    // Process Section
    "process.title": "How We Work",
    "process.step1.title": "Consultation",
    "process.step1.description":
      "Our expert roofers come to your home to assess the situation and discuss your needs.",
    "process.step2.title": "Quote",
    "process.step2.description":
      "You receive a non-binding customized quote with a clear price indication.",
    "process.step3.title": "Execution",
    "process.step3.description":
      "After approval, we get to work immediately with minimal inconvenience to you and your environment.",
    "process.step4.title": "Completion",
    "process.step4.description":
      "We clean up everything neatly and check together whether the result meets your expectations.",

    // Why Us Section
    "whyus.title": "Why AstroDak Service?",
    "whyus.subtitle":
      "Looking for a reliable roofing company? Choose AstroDak Service!",
    "whyus.intro":
      "With years of experience in the Netherlands and abroad, we provide:",
    "whyus.point1": "Professional and clean work",
    "whyus.point2": "Working with honesty and reliability",
    "whyus.point3": "Complete safety – we are VCA certified",
    "whyus.point4": "Fast service without compromising on quality",
    "whyus.point5": "Competitive prices, realistic and affordable",
    "whyus.point6": "Up to 10 years warranty on our work!",
    "whyus.conclusion": "AstroDak Service – for a roof you can count on.",
    "whyus.cta": "Request Free Quote",

    // Reviews Section
    "reviews.title": "What Our Customers Say",
    "reviews.subtitle":
      "Read experiences from satisfied customers who have used our services",
    // Add to the en translations object
    "reviews.form.title": "Leave Your Review",
    "reviews.form.name": "Name",
    "reviews.form.review": "Review ",
    "reviews.form.rating": "Rating",
    "reviews.form.submit": "Submit Review",
    // Contact Section
    "contact.title": "Contact Us",
    "contact.info.title": "Contact Information",
    "contact.info.address": "Address: Salahutunplein in Vught, Netherlands",
    "contact.info.phone": "Phone:",
    "contact.info.email": "Email:",
    "contact.info.hours": "Opening hours: Monday to Friday, 8:00 - 17:00",
    "contact.form.title": "Send Us a Message",
    "contact.form.name": "Full Name",
    "contact.form.email": "Email Address",
    "contact.form.phone": "Phone Number",
    "contact.form.subject": "Subject",
    "contact.form.message": "Message",
    "contact.form.submit": "Send Message",

    // Footer
    "footer.description":
      "Specialized in roof insulation, zinc work, sloped and flat roofs. We offer high-quality solutions for all your roofing needs.",
    "footer.area.title": "Our Service Area",
    "footer.links.title": "Quick Links",
    "footer.contact.title": "Contact Information",
    "footer.contact.address": "Salahutunplein, Vught, Netherlands",
    "footer.contact.hours": "Mon-Fri: 8:00 - 17:00",
    "footer.copyright": "All rights reserved.",

    // WhatsApp
    "whatsapp.tooltip": "Send us a message",
  },
};

// DOM Elements
const header = document.getElementById("mainHeader");
const hamburger = document.getElementById("hamburger");
const mobileMenu = document.getElementById("mobileMenu");
const overlay = document.getElementById("overlay");
const navLinks = document.querySelectorAll(".nav-link, .mobile-nav-link");
const yearSpan = document.getElementById("year");
const contactForm = document.getElementById("contactForm");

// Set current year in footer
if (yearSpan) {
  yearSpan.textContent = new Date().getFullYear();
}

// Language switching functionality
function initializeLanguageSwitcher() {
  const langButtons = document.querySelectorAll(".lang-btn, .mobile-lang-btn");

  langButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const newLang = button.getAttribute("data-lang");
      if (newLang !== currentLanguage) {
        switchLanguage(newLang);
      }
    });
  });
}

function switchLanguage(lang) {
  currentLanguage = lang;

  // Update active language buttons
  document.querySelectorAll(".lang-btn, .mobile-lang-btn").forEach((btn) => {
    btn.classList.remove("active");
    if (btn.getAttribute("data-lang") === lang) {
      btn.classList.add("active");
    }
  });

  // Update HTML lang attribute
  document.documentElement.lang = lang;

  // Translate all elements
  translatePage();

  initializeCategoryFilter();
  // Update projects and reviews for new language - FIX: Use correct function name
  renderProjects(); // Changed from fetchProjects() to renderProjects()
  renderReviews(); // Changed from fetchReviews() to renderReviews()

  // Store language preference
  localStorage.setItem("preferred-language", lang);
}

function translatePage() {
  const elementsToTranslate = document.querySelectorAll("[data-translate]");

  elementsToTranslate.forEach((element) => {
    const key = element.getAttribute("data-translate");
    if (translations[currentLanguage] && translations[currentLanguage][key]) {
      element.textContent = translations[currentLanguage][key];
    }
  });

  // Update select options
  const selectOptions = document.querySelectorAll("option[data-translate]");
  selectOptions.forEach((option) => {
    const key = option.getAttribute("data-translate");
    if (translations[currentLanguage] && translations[currentLanguage][key]) {
      option.textContent = translations[currentLanguage][key];
    }
  });
}

// Header scroll effect
window.addEventListener("scroll", () => {
  if (window.scrollY > 50) {
    header.classList.add("scrolled");
  } else {
    header.classList.remove("scrolled");
  }

  // Highlight active section
  let current = "";
  document.querySelectorAll("section").forEach((section) => {
    const sectionTop = section.offsetTop;
    const sectionHeight = section.clientHeight;

    if (pageYOffset >= sectionTop - 100) {
      current = section.getAttribute("id");
    }
  });

  navLinks.forEach((link) => {
    link.classList.remove("active");
    if (link.getAttribute("href") === `#${current}`) {
      link.classList.add("active");
    }
  });
});

// Mobile menu toggle
hamburger.addEventListener("click", () => {
  hamburger.classList.toggle("active");
  mobileMenu.classList.toggle("active");
  overlay.classList.toggle("active");

  // Toggle hamburger to X
  if (hamburger.classList.contains("active")) {
    hamburger.children[0].style.transform = "rotate(45deg) translate(5px, 6px)";
    hamburger.children[1].style.opacity = "0";
    hamburger.children[2].style.transform =
      "rotate(-45deg) translate(5px, -6px)";
  } else {
    hamburger.children[0].style.transform = "none";
    hamburger.children[1].style.opacity = "1";
    hamburger.children[2].style.transform = "none";
  }
});

// Mobile menu close when clicking any link
document.querySelectorAll(".mobile-nav-link, .mobile-cta").forEach((link) => {
  link.addEventListener("click", () => {
    hamburger.classList.remove("active");
    mobileMenu.classList.remove("active");
    overlay.classList.remove("active");
    hamburger.children[0].style.transform = "none";
    hamburger.children[1].style.opacity = "1";
    hamburger.children[2].style.transform = "none";
  });
});

// Smooth scrolling for all links
document
  .querySelectorAll(".nav-link, .mobile-nav-link, .mobile-cta, .btn")
  .forEach((link) => {
    link.addEventListener("click", (e) => {
      const href = link.getAttribute("href");
      if (href && href.startsWith("#")) {
        e.preventDefault();

        // Get target section
        const targetId = href;
        const targetSection = document.querySelector(targetId);

        if (targetSection) {
          // Scroll to target
          targetSection.scrollIntoView({
            behavior: "smooth",
          });

          // Close mobile menu if open
          if (mobileMenu.classList.contains("active")) {
            hamburger.classList.remove("active");
            mobileMenu.classList.remove("active");
            overlay.classList.remove("active");
            hamburger.children[0].style.transform = "none";
            hamburger.children[1].style.opacity = "1";
            hamburger.children[2].style.transform = "none";
          }
        }
      }
    });
  });

// Contact form submission
document.getElementById("contactForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const submitBtn = this.querySelector('[type="submit"]');
  const originalText = submitBtn.textContent;

  // Disable button during submission
  submitBtn.disabled = true;
  submitBtn.textContent =
    currentLanguage === "nl" ? "Verzenden..." : "Sending...";

  // Prepare form data
  const formData = new FormData(this);
  formData.append("lang", currentLanguage);

  fetch(this.action, {
    method: this.method,
    body: formData,
  })
    .then((response) => {
      if (response.ok) {
        return response.json();
      }
      throw new Error("Network response was not ok.");
    })
    .then((data) => {
      alert(
        currentLanguage === "nl"
          ? "Bericht succesvol verzonden!"
          : "Message sent successfully!"
      );
      this.reset();
    })
    .catch((error) => {
      console.error("Error:", error);
      alert(
        currentLanguage === "nl"
          ? "Fout bij verzenden: " + error.message
          : "Sending failed: " + error.message
      );
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    });
});

// API Integration Class
class AstroDakAPI {
  constructor() {
    this.baseUrl = this._getBaseUrl();
    this.defaultHeaders = {
      "Content-Type": "application/json",
      Accept: "application/json",
    };
    // Keep legacy category mapping for backwards compatibility
    this.categories = [];
    // Add category mapping for legacy support
    this.categoryMap = {
      flat: 1, // Assuming flat roof is category ID 1
      zinc: 2, // Assuming zinc work is category ID 2
      sloped: 3, // Assuming sloped roofs is category ID 3
      chimney: 4, // Assuming chimney repair is category ID 4
    };
  }

  _getBaseUrl() {
    // Ensure this matches where your astrodak_admin folder is served

    return "https://astradakservices.nl/astrodakservice";
  }

  async _request(endpoint, method = "GET", data = null, params = {}) {
    const url = new URL(`${this.baseUrl}/api/${endpoint}`);
    Object.entries(params).forEach(([key, value]) => {
      if (value !== null && value !== undefined) {
        url.searchParams.append(key, value);
      }
    });

    const config = {
      method,
      headers: {
        ...this.defaultHeaders,
        "X-Requested-With": "XMLHttpRequest",
      },
      mode: "cors",
      credentials: "omit",
    };

    if (data) {
      config.body = JSON.stringify(data);
    }

    try {
      const response = await fetch(url, config);
      if (!response.ok) {
        const errorData = await response.json().catch(() => null);
        throw new Error(
          errorData?.message ||
            `HTTP error! status: ${response.status} ${response.statusText}`
        );
      }

      // Handle cases where the server might return an empty 200 OK response (e.g., for OPTIONS)
      const contentType = response.headers.get("content-type");
      if (contentType && contentType.includes("application/json")) {
        return await response.json();
      } else {
        // Return an empty object or a success flag if no JSON is expected
        return {
          success: true,
          message: "Request successful, no JSON response.",
        };
      }
    } catch (error) {
      console.error(`API request failed to ${endpoint}:`, {
        error: error.message,
        url: url.toString(),
      });
      // Return a standardized error object
      return {
        success: false,
        error: error.message,
        url: url.toString(),
      };
    }
  }

  // Get all categories
  async getCategories(lang = "en") {
    if (this.categories.length > 0) {
      return { success: true, data: this.categories };
    }

    const result = await this._request("categories.php", "GET", null, { lang });
    if (result.success && result.data) {
      this.categories = result.data;
    }
    return result;
  }

  // Get projects with enhanced category filtering
  async getProjects(category = null, lang = "en") {
    let categoryId = null;

    // Handle different category input types
    if (category !== null) {
      if (typeof category === "number") {
        // Direct category ID
        categoryId = category;
      } else if (typeof category === "string") {
        // Legacy string mapping or numeric string
        if (this.categoryMap[category] !== undefined) {
          categoryId = this.categoryMap[category];
        } else if (!isNaN(category)) {
          categoryId = parseInt(category);
        }
      }
    }

    return this._request("projects.php", "GET", null, {
      lang,
      category_id: categoryId,
    });
  }
  // Get projects by specific category ID (more explicit method)
  async getProjectsByCategory(categoryId, lang = "en") {
    return this._request("projects.php", "GET", null, {
      lang,
      category_id: categoryId,
    });
  }

  async getReviews(lang = "en") {
    return this._request("reviews.php", "GET", null, {
      lang,
      approved: 1, // Only fetch approved reviews by default
    });
   
  }

  /**
   * Submits a new review to the API.
   * @param {object} reviewData - The data for the review (e.g., {name: "...", review: "...", rating: 5}).
   * @returns {Promise<object>} The API response indicating success or failure.
   */
  async submitReview(reviewData) {
    // Use the internal _request method for consistency
    return this._request("reviews.php", "POST", reviewData);
  }

  _getFullImageUrl(relativePath) {
    if (!relativePath || relativePath.startsWith("http")) return relativePath;
    return `${this.baseUrl}/${relativePath.replace(/^\//, "")}`;
  }
}
const api = new AstroDakAPI();
console.log("API Base URL:", api.baseUrl);

// Current language (should be set elsewhere in your app)
let currentLanguage = "en";

let currentProjectFilter = null; // Track current filter

// Initialize categories dropdown
async function initializeCategoryFilter() {
  const filterDropdown = document.getElementById("projectFilter");
  if (!filterDropdown) return;

  // Show loading state
  filterDropdown.innerHTML = `
    <option value="loading" disabled>
      ${
        currentLanguage === "nl"
          ? "Categorieën laden..."
          : "Loading categories..."
      }
    </option>
  `;

  try {
    const { success, data } = await api.getCategories(currentLanguage);

    if (success && data && data.length > 0) {
      // Clear loading state
      filterDropdown.innerHTML = "";

      // Add "All" option
      const allOption = document.createElement("option");
      allOption.value = "all";
      allOption.textContent =
        currentLanguage === "nl" ? "Alle Projecten" : "All Projects";
      allOption.setAttribute("data-translate", "projects.filter.all");
      filterDropdown.appendChild(allOption);

      // Add category options
      data.forEach((category) => {
        const option = document.createElement("option");
        option.value = category.id;
        option.textContent =
          currentLanguage === "nl" ? category.name_nl : category.name_en;
        filterDropdown.appendChild(option);
      });

      // Set up event listener
      filterDropdown.addEventListener("change", async () => {
        const selectedValue = filterDropdown.value;
        const projectsTitle = document.querySelector(".projects h2");

        if (selectedValue === "all") {
          projectsTitle.textContent =
            translations[currentLanguage]["projects.title"];
          await renderProjects();
        } else {
          // Find the selected category to update the title
          const selectedCategory = data.find((cat) => cat.id == selectedValue);
          if (selectedCategory) {
            projectsTitle.textContent =
              currentLanguage === "nl"
                ? selectedCategory.name_nl
                : selectedCategory.name_en;
          }
          await renderProjectsByCategory(selectedValue);
        }
      });
    } else {
      // Fallback to hardcoded options if API fails
      filterDropdown.innerHTML = `
        <option value="all" data-translate="projects.filter.all">
          ${currentLanguage === "nl" ? "Alle Projecten" : "All Projects"}
        </option>
        <option value="flat" data-translate="projects.filter.flat">
          ${translations[currentLanguage]["projects.filter.flat"]}
        </option>
        <option value="zinc" data-translate="projects.filter.zinc">
          ${translations[currentLanguage]["projects.filter.zinc"]}
        </option>
        <option value="sloped" data-translate="projects.filter.sloped">
          ${translations[currentLanguage]["projects.filter.sloped"]}
        </option>
        <option value="chimney" data-translate="projects.filter.chimney">
          ${translations[currentLanguage]["projects.filter.chimney"]}
        </option>
      `;

      // Set up event listener for fallback options
      filterDropdown.addEventListener("change", async () => {
        const selectedValue = filterDropdown.value;
        const projectsTitle = document.querySelector(".projects h2");

        if (selectedValue === "all") {
          projectsTitle.textContent =
            translations[currentLanguage]["projects.title"];
          await renderProjects();
        } else {
          projectsTitle.textContent =
            translations[currentLanguage][`projects.filter.${selectedValue}`];
          await renderProjects(selectedValue);
        }
      });
    }
  } catch (error) {
    console.error("Failed to initialize categories:", error);
    filterDropdown.innerHTML = `
      <option value="error" disabled>
        ${currentLanguage === "nl" ? "Fout bij laden" : "Loading error"}
      </option>
    `;
  }
}

async function renderProjectsByCategory(categoryId) {
  const projectsGrid = document.querySelector(".projects-grid");
  if (!projectsGrid) return;

  // Show loading state
  projectsGrid.innerHTML = `
    <div class="loading">
      <i class="fas fa-spinner fa-spin"></i>
      ${currentLanguage === "nl" ? "Projecten laden..." : "Loading projects..."}
    </div>
  `;

  try {
    const { success, data } = await api.getProjectsByCategory(
      categoryId,
      currentLanguage
    );

    if (success && data && data.length > 0) {
      projectsGrid.innerHTML = data
        .map(
          (project) => `
        <div class="project-card" data-category="${project.category_id}">
          <img src="${api._getFullImageUrl(project.image)}" 
               loading="lazy" 
               alt="${project.title}"
               class="project-image"
               onerror="this.src='assets/images/fallback-image.jpg'">
          <div class="project-overlay">
            <h3>${project.title}</h3>
            <p>${project.description}</p>
          </div>
        </div>
      `
        )
        .join("");
    } else {
      projectsGrid.innerHTML = `
        <p class="no-projects">
          ${
            currentLanguage === "nl"
              ? "Geen projecten gevonden"
              : "No projects found"
          }
        </p>
      `;
    }
  } catch (error) {
    console.error("Error rendering projects:", error);
    projectsGrid.innerHTML = `
      <p class="error">
        ${
          currentLanguage === "nl"
            ? "Fout bij laden projecten"
            : "Error loading projects"
        }
      </p>
    `;
  }
}

async function renderProjects(filter = null) {
  const projectsGrid = document.querySelector(".projects-grid");
  if (!projectsGrid) return;

  // Show loading state
  projectsGrid.innerHTML = `
    <div class="loading">
      <i class="fas fa-spinner fa-spin"></i>
      ${currentLanguage === "nl" ? "Projecten laden..." : "Loading projects..."}
    </div>
  `;

  try {
    const { success, data, error } = await api.getProjects(
      filter === "all" ? null : filter,
      currentLanguage
    );
    console.log(data);

    if (success && data?.length) {
      projectsGrid.innerHTML = data
        .map((project) => {
          const imageUrl = api._getFullImageUrl(project.image);
          return `
        <div class="project-card" data-category="${project.category_id}">
          <img src="${imageUrl || "assets/images/fallback-image.jpg"}"
               loading="lazy"
               alt="${project.title}"
               width="400"
               height="300"
               class="project-image"
               onerror="this.src='assets/images/fallback-image.jpg'">
          <div class="project-overlay" aria-hidden="true">
            <h3>${project.title}</h3>
            <p>${project.description}</p>
          </div>
        </div>
      `;
        })
        .join("");
    } else if (error) {
      console.error("Error fetching projects:", error);
      projectsGrid.innerHTML = `<p>${
        currentLanguage === "nl"
          ? "Fout bij laden projecten"
          : "Failed to load projects"
      }.</p>`;
    } else {
      projectsGrid.innerHTML = `<p>${
        currentLanguage === "nl"
          ? "Geen projecten gevonden"
          : "No projects found"
      }.</p>`;
    }
  } catch (err) {
    console.error("An unexpected error occurred:", err);
    projectsGrid.innerHTML = `<p>${
      currentLanguage === "nl" ? "Er is iets misgegaan" : "Something went wrong"
    }.</p>`;
  }
}

/**
 * Render reviews to the DOM
 */
async function renderReviews() {
  const reviewsContainer = document.querySelector(".reviews-container");
  if (!reviewsContainer) {
    console.warn("Reviews container not found");
    return;
  }

  // Show loading state
  reviewsContainer.innerHTML = `
    <div class="loading" style="text-align: center; padding: 2rem;">
      <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 1rem;"></i>
      <p>${currentLanguage === "nl" ? "Reviews laden..." : "Loading reviews..."}</p>
    </div>
  `;

  try {
    const { success, data, error } = await api.getReviews(currentLanguage);

    if (success && data?.length) {
      reviewsContainer.innerHTML = data
        .map((review) => {
          const initials = review.name
            .split(" ")
            .map((n) => n[0]?.toUpperCase() || "")
            .join("")
            .slice(0, 2);

          const stars = Array.from({ length: 5 }, (_, i) =>
            i < review.rating
              ? '<i class="fas fa-star" style="color: #ffd700;"></i>'
              : '<i class="far fa-star" style="color: #ddd;"></i>'
          ).join("");

          const publishDate = review.publish
            ? new Date(review.publish).toLocaleDateString(
                currentLanguage === "nl" ? "nl-NL" : "en-US",
                {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                }
              )
            : "";

          return `
          <div class="review-card" style="margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #e0e0e0; border-radius: 8px; background: #fff;">
            <div class="review-header" style="display: flex; align-items: center; margin-bottom: 1rem;">
              <div class="review-avatar" style="width: 50px; height: 50px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 1rem;">
                ${initials}
              </div>
              <div class="review-info">
                <h4 style="margin: 0 0 0.5rem 0; color: #333;">${review.name}</h4>
                <div class="review-stars">${stars}</div>
              </div>
            </div>
            <div class="review-text" style="margin-bottom: 1rem; line-height: 1.6; color: #555;">
              ${review.review}
            </div>
            ${
              publishDate
                ? `<span class="review-date" style="color: #888; font-size: 0.9rem;">${publishDate}</span>`
                : ""
            }
          </div>
        `;
        })
        .join("");
    } else {
      reviewsContainer.innerHTML = `
        <div class="no-reviews" style="text-align: center; padding: 2rem; color: #666;">
          <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
          <p>${currentLanguage === "nl" ? "Nog geen reviews" : "No reviews yet"}</p>
          ${error ? `<small style="color: #dc3545;">${error}</small>` : ""}
        </div>
      `;
    }
  } catch (error) {
    console.error("Review rendering failed:", error);
    reviewsContainer.innerHTML = `
      <div class="error" style="text-align: center; padding: 2rem; color: #dc3545;">
        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
        <p>${
          currentLanguage === "nl"
            ? "Fout bij laden reviews"
            : "Error loading reviews"
        }</p>
        <small>${error.message}</small>
        <button onclick="renderReviews()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
          ${currentLanguage === "nl" ? "Opnieuw proberen" : "Try Again"}
        </button>
      </div>
    `;
  }
}

async function handleReviewSubmit(event) {
  event.preventDefault();
  const form = event.target;
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;

  try {
    // Disable button during submission
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      ${currentLanguage === "nl" ? "Verzenden..." : "Submitting..."}
      <i class="fas fa-spinner fa-spin"></i>
    `;

    const formData = new FormData(form);
    const reviewData = {
      name: formData.get("name"),
      review: formData.get("review"),
      rating: parseInt(formData.get("rating")),
      lang: currentLanguage,
    };

    // Client-side validation
    if (!reviewData.name || !reviewData.review || !reviewData.rating) {
      throw new Error(
        currentLanguage === "nl"
          ? "Vul alle verplichte velden in"
          : "Please fill all required fields"
      );
    }

    if (reviewData.rating < 1 || reviewData.rating > 5) {
      throw new Error(
        currentLanguage === "nl"
          ? "Beoordeling moet tussen 1 en 5 zijn"
          : "Rating must be between 1 and 5"
      );
    }

    const result = await api.submitReview(reviewData);

    if (!result.success) {
      throw new Error(result.error || "Submission failed");
    }

    // Success: Reset form and show success message
    form.reset();
    showAlert(
      currentLanguage === "nl"
        ? "Bedankt voor uw review! Deze wordt binnenkort gepubliceerd."
        : "Thank you for your review! It will be published soon.",
      "success"
    );

    // Re-render reviews to show the new one (if it's immediately approved)
    // Add a small delay to ensure the API has processed the submission
    setTimeout(() => {
      renderReviews();
    }, 1000);

  } catch (error) {
    console.error("Review submission error:", error);
    showAlert(
      error.message || 
      (currentLanguage === "nl" 
        ? "Er is een fout opgetreden bij het verzenden van uw review" 
        : "An error occurred while submitting your review"),
      "error"
    );
  } finally {
    // Always restore the button to its original state
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText; // Fixed: was originalContent, should be originalText
  }
}

// Attach event listeners to all forms
document.querySelectorAll(".submission-form").forEach((form) => {
  form.addEventListener("submit", handleFormSubmit);
});

// Helper function to show alerts
function showAlert(message, type = "info") {
  // Remove any existing alerts first
  document.querySelectorAll('.alert').forEach(alert => alert.remove());
  
  const alert = document.createElement("div");
  alert.className = `alert alert-${type}`;
  alert.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
    color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
    border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb'};
    border-radius: 8px;
    padding: 12px 20px;
    z-index: 10000;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-weight: 500;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  `;
  alert.textContent = message;
  
  document.body.appendChild(alert);
  
  // Trigger animation
  setTimeout(() => {
    alert.style.transform = 'translateX(0)';
  }, 100);

  // Auto remove after 4 seconds
  setTimeout(() => {
    alert.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (alert.parentNode) {
        alert.remove();
      }
    }, 300);
  }, 4000);
}


// Initialize event listeners
document.addEventListener("DOMContentLoaded", () => {
  // Load initial content
  renderProjects();
  renderReviews();

  // Filter projects
  document.querySelectorAll(".project-filter").forEach((button) => {
    button.addEventListener("click", () => {
      renderProjects(button.dataset.filter);
    });
  });

  // Review form submission
  const reviewForm = document.querySelector("#review-form");
  if (reviewForm) {
    reviewForm.addEventListener("submit", handleReviewSubmit);
  }
});

// Initialize everything when DOM is loaded
document.addEventListener("DOMContentLoaded", () => {
  // Check for saved language preference
  const savedLanguage = localStorage.getItem("preferred-language");
  if (savedLanguage && translations[savedLanguage]) {
    currentLanguage = savedLanguage;
  }

  // Initialize language switcher
  initializeLanguageSwitcher();

  // Set initial language
  switchLanguage(currentLanguage);

  // Load initial content
  renderProjects();
  renderReviews();

  // Filter projects when dropdown changes
  const projectFilter = document.getElementById("projectFilter");
  if (projectFilter) {
    projectFilter.addEventListener("change", function () {
      renderProjects(this.value); // Use renderProjects instead of fetchProjects
    });
  }

  // Filter projects with buttons
  document.querySelectorAll(".project-filter").forEach((button) => {
    button.addEventListener("click", () => {
      // Update active button
      document
        .querySelectorAll(".project-filter")
        .forEach((b) => b.classList.remove("active"));
      button.classList.add("active");

      // Render projects with selected filter
      renderProjects(button.dataset.filter);
    });
  });

  // Review form submission
  const reviewForm = document.querySelector("#review-form");
  if (reviewForm) {
    reviewForm.addEventListener("submit", handleReviewSubmit);
  }
});
window.addEventListener('load', () => {
  const img = new Image();
  img.src = 'Platdak2.jpg';
});

// Debug logging
console.log("Fixed bilingual script loaded successfully");
